<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chat + Player</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#121212;color:#EEE;font-family:Arial,sans-serif;display:flex;flex-direction:column;height:100vh;}
  
  #mainUI {
    max-width: 1200px;
    margin: 0 auto;
    box-sizing: border-box;
    display: none;
    flex-direction: row;
    flex: 1;
  }

  @media (min-width: 1600px) {
    #mainUI {
      max-width: 900px;
      margin: 2rem auto;
      border: 1px solid #444;
      border-radius: 10px;
      box-shadow: 0 0 20px #0008;
    }
  }

  @media (max-width: 768px) {
    #mainUI {
      display: flex !important;
      flex-direction: column !important;
      width: 100% !important;
      height: 100vh !important;
      margin: 0 !important;
      padding: 0.5rem !important;
    }
    #playerArea {
      flex: none !important;
      width: 100% !important;
      max-width: 100% !important;
      height: auto !important;
    }
    #chatArea {
      flex: none !important;
      width: 100% !important;
      height: 150px !important;
      border-left: none !important;
      border-top: 1px solid #333 !important;
      margin-top: 0.5rem !important;
      display: flex !important;
    }
  }

  #playerArea{flex:2;background:#222;display:flex;flex-direction:column;align-items:center;padding:1rem;position:relative;}
  video{width:100%;max-width:800px;border-radius:6px;background:#000;}
  #controls{margin:1rem;display:flex;gap:.5rem;flex-wrap:wrap;}
  .btn{background:#ff4500;border:none;color:#FFF;padding:.5rem 1rem;border-radius:5px;cursor:pointer;}
  #chatArea{flex:1;display:flex;flex-direction:column;background:#1f1f1f;border-left:1px solid #333;}
  #chatLog{flex:1;overflow-y:auto;padding:0.5rem;}
  #chatInputArea{padding:0.5rem;display:flex;gap:0.5rem;}
  #chatInput{flex:1;padding:.5rem;border-radius:4px;border:none;background:#222;color:#EEE;}
  #menuSetup,#namePrompt{padding:1rem;display:flex;flex-direction:column;gap:.5rem;align-items:center;}
  #sendChatBtn{display:none;}
  #fileMenu, #playlistMenu {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    padding: 1rem;
    border-radius: 8px;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
    z-index: 10;
    min-width: 300px;
  }
  #fileMenu button, #playlistMenu button {
    background: #444;
    color: white;
    padding: 0.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .closeBtn {
    position: absolute;
    top: 0.2rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    color: #f00;
    font-size: 1.2rem;
    cursor: pointer;
  }
  .playlist-controls {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .playlist-item {
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
  }
  .playlist-item:hover {
    background: #555;
  }
</style>
</head>
<body>
  <div id="menuSetup">
    <input id="roomCode" placeholder="C√≥digo da sala (ex: A91J)" maxlength="4" style="text-transform: uppercase;"/>
    <button id="createRoom" class="btn">Criar Sala</button>
    <button id="joinRoom" class="btn">Entrar na Sala</button>
  </div>

  <div id="namePrompt" style="display:none;">
    <input id="nickname" placeholder="Seu nome de usu√°rio"/>
    <button id="enterRoom" class="btn">Entrar</button>
  </div>

  <div id="mainUI">
    <div id="playerArea">
      <video id="mediaPlayer" controls></video>
      <div id="controls">
        <button id="chooseMediaBtn" class="btn">Escolher Arquivo/Link</button>
        <button id="showPlaylistBtn" class="btn">üìÉ Playlist</button>
      </div>

      <div id="fileMenu">
        <button class="closeBtn" onclick="fileMenu.style.display='none'">‚úñ</button>
        <button id="selectFileBtn">Escolher do dispositivo</button>
        <button id="insertLinkBtn">Inserir link</button>
      </div>

      <div id="playlistMenu">
        <button class="closeBtn" onclick="closePlaylist()">‚úñ</button>
        <div class="playlist-controls">
          <button id="toggleAutoPlay" class="btn">Rep. Autom√°tica: OFF</button>
          <button id="clearPlaylistBtn" class="btn" style="display:none;">Limpar Fila</button>
        </div>
        <div id="playlistContent">Sem arquivos ainda.</div>
      </div>
    </div>
    <div id="chatArea">
      <div id="chatLog"></div>
      <div id="chatInputArea">
        <input id="chatInput" placeholder="Digite sua mensagem"/>
        <button id="sendChatBtn" class="btn">Enviar</button>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script>
(() => {
  // Elementos
  const menuSetup = document.getElementById('menuSetup');
  const namePrompt = document.getElementById('namePrompt');
  const mainUI = document.getElementById('mainUI');
  const roomCodeInput = document.getElementById('roomCode');
  const nicknameInput = document.getElementById('nickname');
  const enterRoomBtn = document.getElementById('enterRoom');
  const createRoomBtn = document.getElementById('createRoom');
  const joinRoomBtn = document.getElementById('joinRoom');
  const mediaPlayer = document.getElementById('mediaPlayer');
  const chatLog = document.getElementById('chatLog');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');
  const chooseMediaBtn = document.getElementById('chooseMediaBtn');
  const fileMenu = document.getElementById('fileMenu');
  const selectFileBtn = document.getElementById('selectFileBtn');
  const insertLinkBtn = document.getElementById('insertLinkBtn');
  const showPlaylistBtn = document.getElementById('showPlaylistBtn');
  const playlistMenu = document.getElementById('playlistMenu');
  const playlistContent = document.getElementById('playlistContent');
  const toggleAutoPlayBtn = document.getElementById('toggleAutoPlay');
  const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');

  // Vari√°veis
  let peer = null;
  let connList = {};
  let isAdmin = false;
  let roomId = '';
  let nickname = '';
  let roomAction = ''; // 'create' or 'join'
  let playlist = [];
  let autoPlay = false;

  // Fun√ß√£o para gerar c√≥digo alfanum√©rico 4 caracteres (ex: A91J)
  function genCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for(let i=0; i<4; i++) {
      code += chars.charAt(Math.floor(Math.random()*chars.length));
    }
    return code;
  }

  // Atualiza a playlist na UI
  function updatePlaylistUI() {
    playlistContent.innerHTML = '';
    if(playlist.length === 0) {
      playlistContent.textContent = 'Sem arquivos ainda.';
      return;
    }
    playlist.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'playlist-item';
      div.textContent = `${item.name} (adicionado por ${item.addedBy})`;
      div.onclick = () => {
        playMedia(item.url);
      };
      playlistContent.appendChild(div);
    });
  }

  // Fun√ß√£o para tocar m√≠dia no player e enviar para todos
  function playMedia(url) {
    mediaPlayer.src = url;
    mediaPlayer.play().catch(() => {});
    // Avisar todos que o media mudou
    broadcast({type:'mediaChange', url});
  }

  // Envia mensagem para todos os conectados
  function broadcast(msg) {
    Object.values(connList).forEach(c => {
      try {
        c.conn.send(msg);
      } catch {}
    });
  }

  // Adiciona mensagem no chat
  function appendChat(msg, isSystem=false) {
    const div = document.createElement('div');
    div.textContent = msg;
    if(isSystem) {
      div.style.fontStyle = 'italic';
      div.style.color = '#AAA';
    }
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  // Recebe mensagens dos peers
  function handleData(peerId, msg) {
    if(!msg || !msg.type) return;
    switch(msg.type) {
      case 'joinRequest':
        if(isAdmin) {
          const accepted = confirm(`${msg.name} quer entrar na sala. Aceitar?`);
          connList[peerId].conn.send({type:'joinResponse', accepted});
          if(accepted) {
            addMember(peerId, msg.name);
            broadcastSystemMessage(`${msg.name} entrou na sala.`);
            // Enviar playlist atual para o novo membro
            connList[peerId].conn.send({type:'playlistUpdate', playlist});
          } else {
            connList[peerId].conn.close();
            delete connList[peerId];
          }
        }
        break;

      case 'joinResponse':
        if(msg.accepted) {
          showMainUI();
          appendChat('Voc√™ entrou na sala!', true);
          nickname = msg.name || nickname;
          if(msg.playlist) {
            playlist = msg.playlist;
            updatePlaylistUI();
          }
          isAdmin = false;
          clearPlaylistBtn.style.display = 'none';
        } else {
          alert('Entrada negada pelo administrador.');
          location.reload();
        }
        break;

      case 'chat':
        appendChat(`${msg.sender}: ${msg.text}`);
        break;

      case 'adminAction':
        if(!isAdmin) {
          if(msg.action === 'kick' || msg.action === 'ban') {
            alert('Voc√™ foi expulso da sala!');
            leaveRoom();
          }
        }
        break;

      case 'mediaChange':
        if(msg.url && msg.url !== mediaPlayer.src) {
          mediaPlayer.src = msg.url;
          mediaPlayer.play().catch(() => {});
        }
        break;

      case 'playlistUpdate':
        if(Array.isArray(msg.playlist)) {
          playlist = msg.playlist;
          updatePlaylistUI();
        }
        break;

      case 'systemMessage':
        appendChat(msg.text, true);
        break;

      case 'kickUser':
        if(msg.target === nickname) {
          alert(msg.message || 'Voc√™ foi expulso da sala!');
          leaveRoom();
        }
        break;

      case 'exitAll':
        alert('O administrador fechou a sala.');
        location.reload();
        break;

      case 'leaveAll':
        alert('O administrador encerrou a sala. Voc√™ foi desconectado.');
        leaveRoom();
        break;
    }
  }

  // Envia mensagem do sistema para todos
  function broadcastSystemMessage(text) {
    appendChat(text, true);
    broadcast({type:'systemMessage', text});
  }

  // Adiciona membro na lista (vis√≠vel s√≥ para admin)
  function addMember(id, name) {
    connList[id].name = name;
    if(isAdmin) {
      clearPlaylistBtn.style.display = 'inline-block'; // mostra bot√£o limpar fila s√≥ para admin
    }
  }

  // Sair da sala
  function leaveRoom() {
    if(peer) {
      peer.destroy();
      peer = null;
    }
    connList = {};
    playlist = [];
    mediaPlayer.src = '';
    chatLog.innerHTML = '';
    mainUI.style.display = 'none';
    menuSetup.style.display = 'flex';
    namePrompt.style.display = 'none';
    nicknameInput.value = '';
    roomCodeInput.value = '';
    nickname = '';
    roomId = '';
    isAdmin = false;
  }

  // Exibe mainUI e esconde setup e nome
  function showMainUI() {
    menuSetup.style.display = 'none';
    namePrompt.style.display = 'none';
    mainUI.style.display = 'flex';
  }

  // Conectar e iniciar PeerJS
  async function startPeer() {
    if(roomAction === 'create') {
      roomId = genCode();
      isAdmin = true;
      peer = new Peer(roomId);
      peer.on('open', id => {
        appendChat(`Sala criada: ${id}`, true);
        showMainUI();
        addMember(id, nickname);
        clearPlaylistBtn.style.display = 'inline-block';
        broadcastSystemMessage(`${nickname} (Admin) entrou na sala.`);
      });
    } else if(roomAction === 'join') {
      roomId = roomCodeInput.value.trim().toUpperCase();
      peer = new Peer();
      peer.on('open', async id => {
        const conn = peer.connect(roomId);
        conn.on('open', () => {
          conn.send({type:'joinRequest', name: nickname});
          conn.on('data', data => handleData(roomId, data));
          connList[roomId] = {conn, name: nickname};
        });
      });
    }

    peer.on('connection', conn => {
      const peerId = conn.peer;
      connList[peerId] = {conn};

      conn.on('data', data => handleData(peerId, data));
      conn.on('close', () => {
        if(connList[peerId]) {
          broadcastSystemMessage(`${connList[peerId].name || peerId} saiu da sala.`);
          delete connList[peerId];
        }
      });
    });

    peer.on('error', err => {
      alert('Erro no Peer: ' + err);
      leaveRoom();
    });
  }

  // Envia mensagem no chat
  function sendMessage(text) {
    if(!text.trim()) return;
    // Verifica comandos
    if(text.startsWith('/')) {
      handleCommand(text);
      return;
    }
    appendChat(`Voc√™: ${text}`);
    broadcast({type:'chat', sender: nickname, text});
    chatInput.value = '';
  }

  // Lida com comandos do admin e usu√°rios
  function handleCommand(text) {
    const parts = text.split(' ');
    const cmd = parts[0].toLowerCase();
    if(cmd === '/kick' && isAdmin) {
      if(parts.length < 2) {
        alert('Use /kick NomeUsuario [Mensagem opcional]');
        return;
      }
      const target = parts[1];
      if(target.toLowerCase() === nickname.toLowerCase()) {
        alert(`O ${genderSuffix(nickname)} Admin${genderSuffix(nickname, true)} n√£o pode ser expulso da sala!`);
        return;
      }
      const msg = parts.slice(2).join(' ') || 'Voc√™ foi expulso da sala!';
      // Procurar conex√£o pelo nome
      const entry = Object.entries(connList).find(([id, c]) => c.name && c.name.toLowerCase() === target.toLowerCase());
      if(entry) {
        const [peerId, connObj] = entry;
        connObj.conn.send({type:'kickUser', target: connObj.name, message: msg});
        broadcastSystemMessage(`${connObj.name} foi expulso da sala pelo admin.`);
        connObj.conn.close();
        delete connList[peerId];
      } else {
        alert('Usu√°rio n√£o encontrado.');
      }
    } else if(cmd === '/exit') {
      if(isAdmin && parts[1] === 'all') {
        broadcast({type:'exitAll'});
        location.reload();
      }
    } else if(cmd === '/leave') {
      leaveRoom();
    } else if(cmd === '/leaveall' && isAdmin) {
      broadcast({type:'leaveAll'});
      leaveRoom();
    } else {
      alert('Comando desconhecido ou voc√™ n√£o tem permiss√£o.');
    }
  }

  // Retorna "a" ou "o" conforme o final do nome para mensagens femininas/masculinas
  function genderSuffix(name, capitalized = false) {
    const lastChar = name.slice(-1).toLowerCase();
    let suffix = 'o'; // padr√£o masculino
    if('aeiou√°√©√≠√≥√∫√£√µ'.includes(lastChar)) suffix = 'a';
    return capitalized ? suffix.toUpperCase() : suffix;
  }

  // Escolher m√≠dia: abrir menu para escolher arquivo ou link
  chooseMediaBtn.onclick = () => {
    fileMenu.style.display = 'flex';
  };

  // Fechar playlists
  function closePlaylist() {
    playlistMenu.style.display = 'none';
  }

  showPlaylistBtn.onclick = () => {
    if(window.innerWidth < 768) {
      // Em celular, abre playlist no lugar do chat
      if(playlistMenu.style.display === 'flex') {
        playlistMenu.style.display = 'none';
        chatArea.style.display = 'flex';
      } else {
        playlistMenu.style.display = 'flex';
        chatArea.style.display = 'none';
      }
    } else {
      // Em desktop, abre janela modal playlist
      playlistMenu.style.display = playlistMenu.style.display === 'flex' ? 'none' : 'flex';
    }
  };

  // Bot√£o escolher arquivo
  selectFileBtn.onclick = () => {
    fileMenu.style.display = 'none';
    const inputFile = document.createElement('input');
    inputFile.type = 'file';
    inputFile.accept = 'video/*,audio/*';
    inputFile.onchange = e => {
      const file = e.target.files[0];
      if(!file) return;
      const url = URL.createObjectURL(file);
      playlist.push({url, name: file.name, addedBy: nickname});
      updatePlaylistUI();
      playMedia(url);
      broadcast({type:'playlistUpdate', playlist});
    };
    inputFile.click();
  };

  // Bot√£o inserir link
  insertLinkBtn.onclick = () => {
    fileMenu.style.display = 'none';
    const url = prompt('Insira a URL do arquivo de m√≠dia');
    if(url) {
      playlist.push({url, name: url, addedBy: nickname});
      updatePlaylistUI();
      playMedia(url);
      broadcast({type:'playlistUpdate', playlist});
    }
  };

  // Bot√£o limpar playlist (apenas para admin)
  clearPlaylistBtn.onclick = () => {
    if(!isAdmin) return;
    playlist = [];
    updatePlaylistUI();
    broadcast({type:'playlistUpdate', playlist});
  };

  // Toggle autoplay
  toggleAutoPlayBtn.onclick = () => {
    autoPlay = !autoPlay;
    toggleAutoPlayBtn.textContent = `Rep. Autom√°tica: ${autoPlay ? 'ON' : 'OFF'}`;
  };

  // Quando o v√≠deo acabar, se autoplay ligado, toca pr√≥ximo da playlist
  mediaPlayer.onended = () => {
    if(!autoPlay || playlist.length === 0) return;
    let currentIndex = playlist.findIndex(i => i.url === mediaPlayer.src);
    if(currentIndex === -1 || currentIndex === playlist.length -1) return;
    const nextItem = playlist[currentIndex+1];
    playMedia(nextItem.url);
  };

  // Envia mensagem do chat ao apertar Enter
  chatInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && chatInput.value.trim()) {
      sendMessage(chatInput.value.trim());
      e.preventDefault();
    }
  });

  sendChatBtn.onclick = () => {
    if(chatInput.value.trim()) sendMessage(chatInput.value.trim());
  };

  // No prompt de nome, entrar com Enter tamb√©m
  nicknameInput.addEventListener('keydown', e => {
    if(e.key === 'Enter' && nicknameInput.value.trim()) {
      enterRoomBtn.click();
      e.preventDefault();
    }
  });

  // Criar sala
  createRoomBtn.onclick = () => {
    roomAction = 'create';
    menuSetup.style.display = 'none';
    namePrompt.style.display = 'flex';
  };

  // Entrar na sala
  joinRoomBtn.onclick = () => {
    roomAction = 'join';
    menuSetup.style.display = 'none';
    namePrompt.style.display = 'flex';
  };

  // Entrar ap√≥s nome
  enterRoomBtn.onclick = () => {
    const nameVal = nicknameInput.value.trim();
    if(!nameVal) return alert('Digite um nome!');
    nickname = nameVal;
    startPeer();
  };

  // Exibir playlist s√≥ para quem criou a sala (admin) bot√£o limpar aparece s√≥ pra admin
  function updateUIForAdmin() {
    clearPlaylistBtn.style.display = isAdmin ? 'inline-block' : 'none';
  }

})();
</script>
</body>
</html>
