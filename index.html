<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat + Player</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#121212;color:#EEE;font-family:Arial,sans-serif;display:flex;flex-direction:column;height:100vh;}
    #mainUI{max-width:1200px;margin:0 auto;display:none;flex:1;flex-direction:row;}
    @media (min-width:1600px){
      #mainUI{max-width:900px;margin:2rem auto;border:1px solid #444;border-radius:10px;box-shadow:0 0 20px #0008;}
    }
    @media (max-width:768px){
      #mainUI{display:flex!important;flex-direction:column!important;width:100%!important;height:100vh!important;margin:0!important;padding:.5rem!important;}
      #playerArea{flex:none!important;width:100%!important;max-width:100%!important;height:auto!important;}
      #chatArea{flex:none!important;width:100%!important;height:150px!important;border-left:none!important;border-top:1px solid #333!important;margin-top:.5rem!important;display:flex!important;}
    }
    #playerArea{flex:2;background:#222;display:flex;flex-direction:column;align-items:center;padding:1rem;position:relative;}
    video{width:100%;max-width:800px;border-radius:6px;background:#000;position:relative;z-index:1;}
    #controls{margin:1rem;display:flex;gap:.5rem;flex-wrap:wrap;position:relative;z-index:1;}
    .btn{background:#ff4500;border:none;color:#FFF;padding:.5rem 1rem;border-radius:5px;cursor:pointer;z-index:1;}
    #chatArea{flex:1;display:flex;flex-direction:column;background:#1f1f1f;border-left:1px solid #333;}
    #chatLog{flex:1;overflow-y:auto;padding:.5rem;}
    #chatInputArea{padding:.5rem;display:flex;gap:.5rem;}
    #chatInput{flex:1;padding:.5rem;border-radius:4px;border:none;background:#222;color:#EEE;}
    #menuSetup,#namePrompt{padding:1rem;display:flex;flex-direction:column;gap:.5rem;align-items:center;}
    #fileMenuModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);display:none;justify-content:center;align-items:center;z-index:9999;}
    #fileMenuContent{background:#333;padding:1.5rem;border-radius:8px;min-width:320px;display:flex;flex-direction:column;gap:.75rem;}
    #fileMenuContent button{background:#444;color:#fff;padding:.75rem;border:none;border-radius:5px;cursor:pointer;font-size:1rem;}

    /* Tela de espera */
    #waitingScreen {
      display:none;
      position:fixed;
      inset:0;
      background:#121212cc;
      color:#EEE;
      font-size:1.3rem;
      font-weight:bold;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      z-index:10000;
    }
    #waitingScreen img {
      width:64px;
      height:64px;
      margin-bottom:1rem;
    }
    #adminPrompt {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #333;
      padding: 0.8rem 1rem;
      border-radius: 8px;
      max-width: 300px;
      z-index: 10001;
      box-shadow: 0 0 10px #0008;
      display: none;
      flex-direction: column;
      gap: 0.5rem;
      color: #EEE;
    }
    #adminPrompt button {
      background: #ff4500;
      border: none;
      color: #FFF;
      padding: 0.4rem 0.8rem;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9rem;
    }
    #adminPrompt .buttons {
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <!-- Tela inicial: criar/entrar -->
  <div id="menuSetup">
    <input id="roomCode" placeholder="CÃ³digo da sala (ex: A91J)" maxlength="4" style="text-transform:uppercase"/>
    <button id="createRoom" class="btn">Criar Sala</button>
    <button id="joinRoom"  class="btn">Entrar na Sala</button>
  </div>
  <!-- Prompt de nickname -->
  <div id="namePrompt" style="display:none;">
    <input id="nickname" placeholder="Seu nome de usuÃ¡rio"/>
    <button id="enterRoom" class="btn">Entrar</button>
  </div>
  <!-- Tela de espera aguardando admin -->
  <div id="waitingScreen" style="display:none;flex;">
    <img src="https://media.tenor.com/On7kvXhzml4AAAAj/loading-load-gif.gif" alt="Loading"/>
    Esperando o Administrador aceitar sua solicitaÃ§Ã£o!
  </div>
  <!-- Prompt para admin aceitar entrada -->
  <div id="adminPrompt">
    <div><strong>SolicitaÃ§Ã£o de entrada:</strong> <span id="pendingUser"></span></div>
    <div class="buttons">
      <button id="acceptUserBtn">Aceitar</button>
      <button id="denyUserBtn">Negar</button>
    </div>
  </div>

  <!-- Main UI -->
  <div id="mainUI">
    <div id="playerArea">
      <video id="mediaPlayer" controls autoplay></video>
      <div id="controls">
        <button id="chooseMediaBtn"   class="btn">Escolher Arquivo/Link/Tela</button>
        <button id="showPlaylistBtn"  class="btn">ðŸ“ƒ Playlist</button>
      </div>
    </div>
    <div id="chatArea">
      <div id="chatLog"></div>
      <div id="chatInputArea">
        <input  id="chatInput" placeholder="Digite sua mensagem" autocomplete="off"/>
        <button id="sendChatBtn" class="btn">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Modal mÃ­dia -->
  <div id="fileMenuModal">
    <div id="fileMenuContent">
      <button id="selectFileBtn">Escolher do dispositivo</button>
      <button id="insertLinkBtn">Inserir link</button>
      <button id="shareScreenBtn">Transmitir Tela</button>
    </div>
  </div>

<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script>
  // Elementos
  const mediaPlayer     = document.getElementById('mediaPlayer');
  const fileMenuModal   = document.getElementById('fileMenuModal');
  const chooseMediaBtn  = document.getElementById('chooseMediaBtn');
  const selectFileBtn   = document.getElementById('selectFileBtn');
  const insertLinkBtn   = document.getElementById('insertLinkBtn');
  const shareScreenBtn  = document.getElementById('shareScreenBtn');
  const menuSetup       = document.getElementById('menuSetup');
  const namePrompt      = document.getElementById('namePrompt');
  const nicknameInput   = document.getElementById('nickname');
  const enterRoomBtn    = document.getElementById('enterRoom');
  const joinRoomBtn     = document.getElementById('joinRoom');
  const createRoomBtn   = document.getElementById('createRoom');
  const chatLog         = document.getElementById('chatLog');
  const chatInput       = document.getElementById('chatInput');
  const sendChatBtn     = document.getElementById('sendChatBtn');
  const mainUI          = document.getElementById('mainUI');
  const waitingScreen   = document.getElementById('waitingScreen');
  const adminPrompt     = document.getElementById('adminPrompt');
  const pendingUserSpan = document.getElementById('pendingUser');
  const acceptUserBtn   = document.getElementById('acceptUserBtn');
  const denyUserBtn     = document.getElementById('denyUserBtn');

  // Estado
  let peer, connList = {}, roomID = '', isAdmin = false, myName = '', currentMedia = null;
  let pendingRequests = {}; // para controlar pedidos pendentes (peerId -> {name, peerId})

  // Append chat
  function appendChat(msg){
    const d = document.createElement('div');
    d.textContent = msg;
    chatLog.appendChild(d);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  // Envia dados a todos
  function sendToAll(data){
    Object.values(connList).forEach(c=>c.conn.send(data));
  }

  // Envia chat
  function sendChatMessage(text){
    if(!text.trim()) return;
    appendChat(myName + ': ' + text);
    sendToAll({type:'chat', name:myName, msg:text});
  }

  // abrir/fechar modal
  chooseMediaBtn.onclick = ()=> fileMenuModal.style.display='flex';
  fileMenuModal.onclick = e=>{
    if(e.target===fileMenuModal) fileMenuModal.style.display='none';
  };

  // Upload arquivo
  selectFileBtn.onclick = ()=>{
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='video/*,audio/*';
    inp.onchange=()=>{
      const f=inp.files[0];
      if(!f) return;
      const url=URL.createObjectURL(f);
      currentMedia={type:'media',url, time:0, paused:false};
      mediaPlayer.srcObject=null; mediaPlayer.src=url; mediaPlayer.play();
      sendToAll(currentMedia);
      fileMenuModal.style.display='none';
    };
    inp.click();
  };

  // Link
  insertLinkBtn.onclick=()=>{
    const url=prompt('Cole o link da mÃ­dia:');
    if(!url) return;
    currentMedia={type:'media',url,time:0,paused:false};
    mediaPlayer.srcObject=null; mediaPlayer.src=url; mediaPlayer.play();
    sendToAll(currentMedia);
    fileMenuModal.style.display='none';
  };

  // Transmitir tela
  shareScreenBtn.onclick=async()=>{
    try{
      const stream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
      currentMedia={type:'stream'};
      mediaPlayer.srcObject=stream; mediaPlayer.play();
      Object.values(connList).forEach(c=>{
        const call=peer.call(c.conn.peer, stream);
        c.call=call;
      });
      fileMenuModal.style.display='none';
    }catch(err){
      alert('Erro: '+err);
    }
  };

  // Sincronizar play/pause do admin
  mediaPlayer.onplay = ()=>{
    if(isAdmin && currentMedia && currentMedia.type==='media'){
      currentMedia.time=mediaPlayer.currentTime;
      currentMedia.paused=false;
      sendToAll(currentMedia);
    }
  };
  mediaPlayer.onpause=()=>{
    if(isAdmin && currentMedia && currentMedia.type==='media'){
      currentMedia.time=mediaPlayer.currentTime;
      currentMedia.paused=true;
      sendToAll(currentMedia);
    }
  };

  // Chamada WebRTC
  function setupCallHandlers(){
    peer.on('call', call=>{
      call.answer();
      call.on('stream',stream=>{
        mediaPlayer.srcObject=stream;
        mediaPlayer.play();
      });
    });
  }

  // Criar sala
  function createRoom(code){
    peer=new Peer(code);
    isAdmin=true;
    peer.on('open',()=>{
      appendChat('[Sistema] Sala criada: '+code);
    });
    peer.on('connection',conn=>{
      conn.on('data',data=>{
        if(data.type==='media'){
          currentMedia=data;
          mediaPlayer.srcObject=null;
          mediaPlayer.src=data.url;
          mediaPlayer.onloadedmetadata=()=>{
            mediaPlayer.currentTime=data.time||0;
            data.paused?mediaPlayer.pause():mediaPlayer.play();
          };
        }
        if(data.type==='chat'){
          appendChat(data.name+': '+data.msg);
        }
        if(data.type==='joinRequest'){
          // novo pedido de entrada
          pendingRequests[conn.peer] = { name: data.name, peerId: conn.peer, conn };
          pendingUserSpan.textContent = data.name;
          adminPrompt.style.display = 'flex';
          appendChat(`[Sistema] Pedido de entrada de ${data.name}`);
        }
        if(data.type==='joinAccept'){
          // usuario aceito pelo admin - cliente
          waitingScreen.style.display = 'none';
          namePrompt.style.display = 'flex';
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
        }
        if(data.type==='joinDeny'){
          alert('O administrador negou sua entrada na sala.');
          waitingScreen.style.display = 'none';
          menuSetup.style.display = 'flex';
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
        }
      });
      connList[conn.peer]={conn};
    });
    setupCallHandlers();
  }

  // Entrar em sala
  function joinRoom(code, userName){
    peer=new Peer();
    isAdmin=false;
    peer.on('open',()=>{
      const conn=peer.connect(code);
      conn.on('open',()=>{
        // envia pedido de entrada ao admin
        conn.send({type:'joinRequest', name: userName});
      });
      conn.on('data',data=>{
        if(data.type==='media'){
          mediaPlayer.srcObject=null;
          mediaPlayer.src=data.url;
          mediaPlayer.onloadedmetadata=()=>{
            mediaPlayer.currentTime=data.time||0;
            data.paused?mediaPlayer.pause():mediaPlayer.play();
          };
        }
        if(data.type==='chat') appendChat(data.name+': '+data.msg);
        if(data.type==='join') appendChat('[Sistema] '+data.name+' entrou na sala.');
        if(data.type==='joinAccept'){
          // recebido do admin, usuÃ¡rio liberado para entrar
          waitingScreen.style.display = 'none';
          namePrompt.style.display = 'none';
          mainUI.style.display = 'flex';
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
          myName = userName;
          sendChatMessage('Entrou na sala!');
        }
        if(data.type==='joinDeny'){
          alert('O administrador negou sua entrada na sala.');
          waitingScreen.style.display = 'none';
          menuSetup.style.display = 'flex';
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
        }
      });
      connList[code]={conn};
    });
    setupCallHandlers();
  }

  // Eventos botÃµes criar sala
  createRoomBtn.onclick=()=>{
    roomID=Math.random().toString(36).slice(2,6).toUpperCase();
    menuSetup.style.display='none';
    namePrompt.style.display='flex';
    enterRoomBtn.onclick=()=>{
      myName=nicknameInput.value.trim()||'UsuÃ¡rio';
      namePrompt.style.display='none';
      mainUI.style.display='flex';
      mediaPlayer.controls=true;
      createRoom(roomID);
    };
  };

  // Eventos botÃµes entrar na sala
  joinRoomBtn.onclick=()=>{
    const code=document.getElementById('roomCode').value.trim().toUpperCase();
    if(!code) return alert('Informe o cÃ³digo!');
    // Mostrar tela de espera direto
    waitingScreen.style.display = 'flex';
    menuSetup.style.display = 'none';
    chatInput.disabled = true;
    sendChatBtn.disabled = true;

    // Conectar ao peer para enviar pedido de entrada
    // Criar conexÃ£o temporÃ¡ria peer para enviar joinRequest e receber resposta
    // O nickname serÃ¡ perguntado APÃ“S a aprovaÃ§Ã£o do admin
    peer = new Peer();
    peer.on('open', () => {
      const conn = peer.connect(code);
      conn.on('open', () => {
        // Enviar joinRequest com nome vazio por enquanto
        conn.send({ type: 'joinRequest', name: 'Solicitante' });
      });
      conn.on('data', data => {
        if (data.type === 'joinAccept') {
          // Admin aceitou, agora mostra o prompt de nome e cria conexÃ£o definitiva
          waitingScreen.style.display = 'none';
          namePrompt.style.display = 'flex';
          adminPrompt.style.display = 'none';
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
          conn.close();
          peer.destroy();

          enterRoomBtn.onclick = () => {
            const chosenName = nicknameInput.value.trim() || 'UsuÃ¡rio';
            joinRoom(code, chosenName);
            namePrompt.style.display = 'none';
          };
        }
        if (data.type === 'joinDeny') {
          alert('O administrador negou sua entrada na sala.');
          waitingScreen.style.display = 'none';
          menuSetup.style.display = 'flex';
          adminPrompt.style.display = 'none';
          chatInput.disabled = false;
          sendChatBtn.disabled = false;
          conn.close();
          peer.destroy();
        }
      });
      conn.on('error', () => {
        alert('Erro ao conectar com a sala.');
        waitingScreen.style.display = 'none';
        menuSetup.style.display = 'flex';
      });
    });
  };

  // Admin aceitar ou negar
  acceptUserBtn.onclick = () => {
    // pegar primeiro pedido pendente
    const keys = Object.keys(pendingRequests);
    if(keys.length === 0) return;
    const peerId = keys[0];
    const req = pendingRequests[peerId];
    req.conn.send({ type: 'joinAccept' });
    appendChat(`[Sistema] ${req.name} foi aceito na sala.`);
    connList[peerId] = req; // manter conexÃ£o na lista
    delete pendingRequests[peerId];
    adminPrompt.style.display = 'none';
  };
  denyUserBtn.onclick = () => {
    const keys = Object.keys(pendingRequests);
    if(keys.length === 0) return;
    const peerId = keys[0];
    const req = pendingRequests[peerId];
    req.conn.send({ type: 'joinDeny' });
    appendChat(`[Sistema] ${req.name} teve a entrada negada.`);
    req.conn.close();
    delete pendingRequests[peerId];
    adminPrompt.style.display = 'none';
  };

  // Chat send
  sendChatBtn.onclick=()=>{
    sendChatMessage(chatInput.value);
    chatInput.value='';
  };
  chatInput.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){
      e.preventDefault();
      sendChatMessage(chatInput.value);
      chatInput.value='';
    }
  });

  // Enter no nickname
  nicknameInput.addEventListener('keydown',e=>{
    if(e.key==='Enter') enterRoomBtn.click();
  });
</script>
</body>
</html>
