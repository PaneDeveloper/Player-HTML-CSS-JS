<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Chat de Voz Web</title>
<style>
  *{ box-sizing:border-box; margin:0; padding:0 }
  body{ display:flex; flex-direction:column; align-items:center;
    background:#111; color:#fff; font-family:Arial,sans-serif; height:100vh; }
  #mainControls,#roomArea,#chatRoom{ width:100%; max-width:500px; margin-top:1rem; }
  input,button{ padding:0.6rem 1rem; border-radius:5px; border:none; font-size:1rem; }
  input{ width:calc(100% - 2rem); margin-bottom:0.5rem; }
  button{ background:#ff4500; color:#fff; cursor:pointer; margin-right:0.5rem; }
  button.small{ padding:0.4rem 0.8rem; font-size:0.9rem; }
  #status{ margin-top:1rem; font-size:0.9rem; color:#aaa; }
  #chatRoom{ display:none; flex:1; width:100%; max-width:800px;
    box-shadow:0 0 10px rgba(0,0,0,0.5); border-radius:6px;
    background:#1e1e1e; padding:1rem; position:relative;
    display:flex; flex-direction:column; }
  #roomInfo{ font-size:0.9rem; margin-bottom:0.5rem; }
  #participants{ display:flex; flex-wrap:wrap; gap:0.5rem; margin-bottom:1rem; }
  .participant{ display:flex; align-items:center; gap:0.5rem;
    background:#333; padding:0.5rem; border-radius:5px; position:relative; }
  .participant.speaking{ border:2px solid #4ea8de; }
  .participant img{ width:32px; height:32px; border-radius:50%; object-fit:cover; }
  .participant .name{ color:#fff; }
  .controlsRow{ display:flex; gap:0.5rem; margin-bottom:0.5rem; }
  #chatBox{ flex:1; overflow-y:auto; background:#222; padding:0.5rem; border-radius:4px; margin-bottom:0.5rem; }
  .message{ margin-bottom:0.5rem; word-wrap:break-word; }
  .message .user{ font-weight:600; margin-right:0.5rem; }
  #msgInputRow{ display:flex; gap:0.5rem; }
  #msgInput{ flex:1; padding:0.5rem; border-radius:4px; border:none; }
  #emojiPanel{ display:none; position:absolute; bottom:60px; right:20px;
    background:#333; padding:0.5rem; border-radius:5px; max-width:200px; }
  #emojiPanel span{ cursor:pointer; padding:0.3rem; font-size:1.2rem; }
  #configMenu{ display:none; position:absolute; top:10px; right:10px;
    background:#333; padding:0.5rem; border-radius:5px; z-index:10; }
  #configMenu button{ display:block; width:100%; margin-bottom:0.3rem; background:none; color:#fff; }
</style>
</head>
<body>

<div id="mainControls">
  <input type="text" id="roomInput" placeholder="Código da Sala (4 caracteres)" maxlength="4" />
  <button id="createBtn">Criar Sala</button>
  <button id="joinBtn">Entrar na Sala</button>
  <div id="status">Nenhuma conexão ativa.</div>
</div>

<div id="chatRoom">
  <div id="roomInfo"></div>
  <div id="participants"></div>
  <div class="controlsRow">
    <button id="micToggleBtn" class="small">🔇 Mudo</button>
    <button id="disconnectBtn" class="small" style="background:#c03;">📞 Desligar</button>
    <button id="screenShareBtn" class="small">🖥️ Compartilhar Tela</button>
    <button id="configBtn" class="small">⚙️</button>
  </div>
  <div id="configMenu">
    <button id="changeNameBtn">Mudar Nome</button>
    <button id="changePhotoBtn">Mudar Foto</button>
    <button id="resetProfileBtn">Resetar Nome/Foto</button>
    <button id="toggleTipsBtn">Desativar Dicas</button>
    <button id="clearChatBtn">Limpar Chat</button>
  </div>
  <div id="chatBox"></div>
  <div id="emojiPanel">😀 😃 😄 😁 😆 😅 😂 😉 😊 😋 😎 😍</div>
  <div id="msgInputRow">
    <input type="text" id="msgInput" placeholder="Digite Sua Mensagem" autocomplete="off" />
    <button id="sendMsgBtn">Enviar</button>
    <button id="emojiBtn" class="small">😊</button>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
(async()=>{
  const roomInput = document.getElementById('roomInput');
  const createBtn = document.getElementById('createBtn');
  const joinBtn = document.getElementById('joinBtn');
  const status = document.getElementById('status');
  const chatRoom = document.getElementById('chatRoom');
  const roomInfo = document.getElementById('roomInfo');
  const participantsDiv = document.getElementById('participants');
  const micToggleBtn = document.getElementById('micToggleBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const screenShareBtn = document.getElementById('screenShareBtn');
  const configBtn = document.getElementById('configBtn');
  const configMenu = document.getElementById('configMenu');
  const changeNameBtn = document.getElementById('changeNameBtn');
  const changePhotoBtn = document.getElementById('changePhotoBtn');
  const resetProfileBtn = document.getElementById('resetProfileBtn');
  const toggleTipsBtn = document.getElementById('toggleTipsBtn');
  const clearChatBtn = document.getElementById('clearChatBtn');
  const chatBox = document.getElementById('chatBox');
  const msgInput = document.getElementById('msgInput');
  const sendMsgBtn = document.getElementById('sendMsgBtn');
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPanel = document.getElementById('emojiPanel');

  let peer, conn, call, localStream, screenCall;
  let roomId, isAdmin=false;
  let participantCount=0, participants={};
  let showTips=true;

  function genRoomCode(){
    const chars='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let s='';
    for(let i=0;i<4;i++) s+=chars[Math.floor(Math.random()*chars.length)];
    return s;
  }

  async function getAudioStream(){
    return navigator.mediaDevices.getUserMedia({audio:true});
  }

  function enterRoom(){
    chatRoom.style.display='flex';
    roomInfo.textContent=`Sala: ${roomId} ${isAdmin?'(ADM)':''}`;
    status.textContent='Conectado!';
  }

  function addParticipant(id){
    const div=document.createElement('div');
    div.className='participant';
    div.id=`p-${id}`;
    participants[id]={div,nick:`Usuário ${Object.keys(participants).length}`, photo:null};
    updateParticipant(id);
  }

  function updateParticipant(id){
    const {div,nick,photo} = participants[id];
    div.innerHTML='';
    const img=document.createElement('img');
    img.src=photo||'https://via.placeholder.com/32';
    const span=document.createElement('span');
    span.className='name'; span.textContent=nick;
    div.append(img,span);
    participantsDiv.appendChild(div);
  }

  function removeParticipant(id){
    const o=participants[id];
    if(o){
      o.div.remove();
      delete participants[id];
    }
  }

  function sendChat(msg){
    conn.send({type:'chat', msg});
    appendMessage(participants[peer.id].nick,msg);
  }

  function appendMessage(user,msg){
    const m=document.createElement('div');
    m.className='message';
    m.innerHTML=`<span class="user">${user}:</span>${msg}`;
    chatBox.append(m);
    chatBox.scrollTop=chatBox.scrollHeight;
  }

  sendMsgBtn.onclick=()=>{
    if(!conn||conn.open===false) return;
    const t = msgInput.value.trim(); if(!t) return;
    if(showTips&&t) showTips=false;
    sendChat(t); msgInput.value='';
  };
  msgInput.addEventListener('keydown',e=>{
    if(e.key==='Enter'){
      e.preventDefault();
      sendMsgBtn.click();
    }
  });
  emojiBtn.onclick=()=>{
    emojiPanel.style.display = emojiPanel.style.display==='block'?'none':'block';
  };
  emojiPanel.addEventListener('click',e=>{
    if(e.target.textContent){
      msgInput.value+=e.target.textContent;
    }
  });

  micToggleBtn.onclick=()=>{
    if(localStream){
      const enabled = localStream.getAudioTracks()[0].enabled;
      localStream.getAudioTracks()[0].enabled = !enabled;
      micToggleBtn.textContent = enabled ? '🔈 Mudo' : '🔇 Microfone';
    }
  };

  disconnectBtn.onclick=()=>{
    conn.close();
    if(call) call.close();
    if(screenCall) screenCall.close();
    location.reload();
  };

  screenShareBtn.onclick=async()=>{
    if(navigator.mediaDevices.getDisplayMedia){
      const screenStream = await navigator.mediaDevices.getDisplayMedia({video:true});
      peer.call(roomId, screenStream);
      alert('Compartilhando tela agora!');
    } else alert('Navegador não suporta Compartilhamento de tela.');
  };

  configBtn.onclick=()=> configMenu.style.display = configMenu.style.display==='block'?'none':'block';
  changeNameBtn.onclick=()=>{
    const newName = prompt('Novo nome:');
    if(newName) {
      participants[peer.id].nick = newName;
      updateParticipant(peer.id);
    }
  };
  changePhotoBtn.onclick=async()=>{
    const url = prompt('URL da imagem de perfil (jpg/png/ico):');
    if(url) {
      participants[peer.id].photo = url;
      updateParticipant(peer.id);
    }
  };
  resetProfileBtn.onclick=()=>{
    participants[peer.id].nick = `Usuário ${Object.keys(participants).length}`;
    participants[peer.id].photo = null;
    updateParticipant(peer.id);
  };
  toggleTipsBtn.onclick=()=>{
    showTips = !showTips;
    toggleTipsBtn.textContent = showTips ? 'Desativar Dicas' : 'Ativar Dicas';
  };
  clearChatBtn.onclick=()=>{
    chatBox.innerHTML='';
  };

  createBtn.onclick=async()=>{
    roomId = genRoomCode();
    isAdmin=true;
    peer = new Peer(roomId);
    peer.on('open',async id=>{
      roomInput.value=id;
      enterRoom();
      participantsDiv.innerHTML='';
      addParticipant(id);
    });
    peer.on('connection',c=>{
      conn=c;
      conn.on('open',()=>{
        conn.on('data',data=>{
          if(data.type==='chat') appendMessage(participants[c.peer].nick,data.msg);
        });
        conn.send({type:'join', id:peer.id});
        addParticipant(c.peer);
      });
    });
    localStream = await getAudioStream();
  };

  joinBtn.onclick=async()=>{
    roomId = roomInput.value.trim();
    if(roomId.length!==4) return alert('Código inválido!');
    peer = new Peer();
    peer.on('open', async id=>{
      conn = peer.connect(roomId);
      conn.on('open',async()=>{
        enterRoom();
        participantsDiv.innerHTML='';
        addParticipant(id);
        conn.on('data',data=>{
          if(data.type==='chat') appendMessage(participants[data.from].nick,data.msg);
          if(data.type==='join' && isAdmin) conn.send({type:'chat', msg:'Bem-vindo '+data.id});
        });
        conn.send({type:'join', id:id});
      });
    });
    localStream = await getAudioStream();
    call = peer.call(roomId, localStream);
    call.on('stream',stream=>{
      const a = new Audio();
      a.srcObject = stream; a.play();
    });
  };

})();
</script>
</body>
</html>
