<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chat + Player</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#121212;color:#EEE;font-family:Arial,sans-serif;display:flex;flex-direction:column;height:100vh;}
  
  #mainUI {
    max-width: 1200px;
    margin: 0 auto;
    box-sizing: border-box;
    display: flex;
    flex-direction: row;
    flex: 1;
  }

  @media (min-width: 1600px) {
    #mainUI {
      max-width: 900px;
      margin: 2rem auto;
      border: 1px solid #444;
      border-radius: 10px;
      box-shadow: 0 0 20px #0008;
    }
  }

  @media (max-width: 768px) {
    #mainUI {
      display: flex !important;
      flex-direction: column !important;
      width: 100% !important;
      height: 100vh !important;
      margin: 0 !important;
      padding: 0.5rem !important;
    }
    #playerArea {
      flex: none !important;
      width: 100% !important;
      max-width: 100% !important;
      height: auto !important;
    }
    #chatArea {
      flex: none !important;
      width: 100% !important;
      height: 150px !important;
      border-left: none !important;
      border-top: 1px solid #333 !important;
      margin-top: 0.5rem !important;
      display: flex !important;
    }
  }

  #playerArea{flex:2;background:#222;display:flex;flex-direction:column;align-items:center;padding:1rem;position:relative;}
  video{width:100%;max-width:800px;border-radius:6px;background:#000;}
  #controls{margin:1rem;display:flex;gap:.5rem;flex-wrap:wrap;}
  .btn{background:#ff4500;border:none;color:#FFF;padding:.5rem 1rem;border-radius:5px;cursor:pointer;}
  #chatArea{flex:1;display:flex;flex-direction:column;background:#1f1f1f;border-left:1px solid #333;}
  #chatLog{flex:1;overflow-y:auto;padding:0.5rem;}
  #chatInputArea{padding:0.5rem;display:flex;gap:0.5rem;}
  #chatInput{flex:1;padding:.5rem;border-radius:4px;border:none;background:#222;color:#EEE;}
  #menuSetup,#namePrompt{padding:1rem;display:flex;flex-direction:column;gap:.5rem;align-items:center;}
  #sendChatBtn{display:none;}

  #fileMenu, #playlistMenu {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    padding: 1rem;
    border-radius: 8px;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
    z-index: 10;
    min-width: 300px;
  }
  #fileMenu button, #playlistMenu button {
    background: #444;
    color: white;
    padding: 0.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .closeBtn {
    position: absolute;
    top: 0.2rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    color: #f00;
    font-size: 1.2rem;
    cursor: pointer;
  }
  .playlist-controls {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .playlist-item {
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
  }
  .playlist-item:hover {
    background: #555;
  }
</style>
</head>
<body>

<div id="menuSetup">
  <input id="roomCode" placeholder="CÃ³digo da sala (ex: MX09)"/>
  <button id="createRoom" class="btn">Criar Sala</button>
  <button id="joinRoom" class="btn">Entrar na Sala</button>
</div>

<div id="namePrompt" style="display:none;">
  <input id="nickname" placeholder="Seu nome de usuÃ¡rio"/>
  <button id="enterRoom" class="btn">Entrar</button>
</div>

<div id="mainUI" style="display:none;">
  <div id="playerArea">
    <video id="mediaPlayer" controls></video>
    <div id="controls">
      <button id="chooseMediaBtn" class="btn">Escolher Arquivo/Link</button>
      <button id="showPlaylistBtn" class="btn">ðŸ“ƒ Playlist</button>
    </div>

    <div id="fileMenu">
      <button class="closeBtn" onclick="fileMenu.style.display='none'">âœ–</button>
      <button id="selectFileBtn">Escolher do dispositivo</button>
      <button id="insertLinkBtn">Inserir link</button>
    </div>

    <div id="playlistMenu">
      <button class="closeBtn" onclick="closePlaylist()">âœ–</button>
      <div class="playlist-controls">
        <button id="toggleAutoPlay" class="btn">Rep. AutomÃ¡tica: OFF</button>
        <button id="clearPlaylistBtn" class="btn" style="display:none;">Limpar Fila</button>
      </div>
      <div id="playlistContent">Sem arquivos ainda.</div>
    </div>
  </div>
  <div id="chatArea">
    <div id="chatLog"></div>
    <div id="chatInputArea">
      <input id="chatInput" placeholder="Digite sua mensagem"/>
      <button id="sendChatBtn" class="btn">Enviar</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const menuSetup = document.getElementById('menuSetup');
  const namePrompt = document.getElementById('namePrompt');
  const mainUI = document.getElementById('mainUI');
  const chatLog = document.getElementById('chatLog');
  const chatInput = document.getElementById('chatInput');
  const roomCodeInput = document.getElementById('roomCode');
  const nicknameInput = document.getElementById('nickname');
  const createBtn = document.getElementById('createRoom');
  const joinBtn = document.getElementById('joinRoom');
  const enterRoomBtn = document.getElementById('enterRoom');

  const chooseMediaBtn = document.getElementById('chooseMediaBtn');
  const fileMenu = document.getElementById('fileMenu');
  const showPlaylistBtn = document.getElementById('showPlaylistBtn');
  const playlistMenu = document.getElementById('playlistMenu');
  const playlistContent = document.getElementById('playlistContent');
  const mediaPlayer = document.getElementById('mediaPlayer');
  const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');
  const toggleAutoPlay = document.getElementById('toggleAutoPlay');
  const chatArea = document.getElementById('chatArea');
  const selectFileBtn = document.getElementById('selectFileBtn');
  const insertLinkBtn = document.getElementById('insertLinkBtn');

  let peer, connList = {}, isAdmin = false;
  let roomID = null, nickname = '', userCount = 0;
  const playlist = [];
  let autoPlay = false;

  function genCode(){return Math.random().toString(36).slice(2,6).toUpperCase();}

  function appendChat(msg){ 
    const d=document.createElement('div');
    d.textContent=msg;
    chatLog.append(d);
    chatLog.scrollTop=chatLog.scrollHeight;
  }

  function announceJoin(name){
    Object.values(connList).forEach(c=>{
      c.conn.send({type:'chat',sender:'Sistema',text:`${name} entrou na sala.`});
    });
    appendChat(`Sistema: ${name} entrou na sala.`);
  }

  function enterCall(){
    namePrompt.style.display='none';
    mainUI.style.display='flex';
    if(isAdmin) clearPlaylistBtn.style.display = 'inline-block';
  }

  function leaveCall(){
    if(peer) peer.destroy();
    Object.values(connList).forEach(c=>c.conn.close());
    connList={}; chatLog.innerHTML='';
    location.reload();
  }

  createBtn.onclick=()=>{
    roomID = genCode();
    isAdmin = true;
    menuSetup.style.display = 'none';
    namePrompt.style.display = 'flex';
  };

  joinBtn.onclick=()=>{
    roomID = roomCodeInput.value.trim();
    if(roomID){
      menuSetup.style.display = 'none';
      namePrompt.style.display = 'flex';
    }
  };

  enterRoomBtn.onclick=()=>{
    nickname = nicknameInput.value.trim() || 'UsuÃ¡rio';
    peer = isAdmin ? new Peer(roomID) : new Peer();

    peer.on('open', id => {
      if(isAdmin){
        appendChat('Sala criada com ID: ' + id);
      } else {
        const conn = peer.connect(roomID);
        conn.on('open', ()=>{
          conn.send({type:'joinRequest',name:nickname});
        });
        conn.on('data',msg=>handleData(roomID,msg));
        connList[roomID]={conn,initiator:true, nickname};
      }
      if(isAdmin){
        peer.on('connection', c=>{
          c.on('open',()=>{
            userCount++;
            connList[c.peer]={conn:c};
            c.on('data',msg=>handleData(c.peer,msg));
          });
        });
      }
      enterCall();
    });
  };

  function processCommand(text){
    if(!isAdmin) return false;
    if(!text.startsWith('/')) return false;

    const kickMatch = text.match(/^\/kick\s+(\S+)\s+(.+)$/i);
    if(kickMatch){
      const userToKick = kickMatch[1];
      const kickMsg = kickMatch[2];

      if(userToKick.toLowerCase() === nickname.toLowerCase()){
        const nome = userToKick.trim();
        const ultimoChar = nome.charAt(nome.length -1).toLowerCase();
        const feminino = (ultimoChar === 'a');
        if(feminino){
          alert(`A Admin nÃ£o pode ser expulsa da sala!`);
        } else {
          alert(`O Admin nÃ£o pode ser expulso da sala!`);
        }
        return true;
      }

      let targetPeerId = null;
      for(const [pid, c] of Object.entries(connList)){
        if(c.nickname && c.nickname.toLowerCase() === userToKick.toLowerCase()){
          targetPeerId = pid;
          break;
        }
      }
      if(targetPeerId){
        connList[targetPeerId].conn.send({type:'adminAction', action:'kick', message: kickMsg});
        appendChat(`Sistema: UsuÃ¡rio ${userToKick} foi kickado. Mensagem: ${kickMsg}`);
        return true;
      } else {
        appendChat(`Sistema: UsuÃ¡rio ${userToKick} nÃ£o encontrado.`);
        return true;
      }
    }

    if(/^\/exit(\s+all\s+close\s+tab)?$/i.test(text)){
      Object.values(connList).forEach(c=>{
        c.conn.send({type:'adminAction', action:'exit'});
      });
      appendChat('Sistema: O administrador encerrou a sala. Todos serÃ£o desconectados.');
      leaveCall();
      return true;
    }

    return false;
  }

  function handleData(peerId, msg){
    if(msg.type==='joinRequest' && isAdmin){
      const ok = confirm(`${msg.name} quer entrar na sala. Permitir?`);
      connList[peerId].conn.send({type:'joinResponse',accepted:ok});
      if(ok){
        connList[peerId].nickname = msg.name;
        announceJoin(msg.name);
      }
    }
    if(msg.type==='joinResponse'){
      if(msg.accepted){
        appendChat('VocÃª entrou na sala!');
      } else {
        alert('Entrada negada pelo administrador.');
      }
    }
    if(msg.type==='chat'){
      appendChat(`${msg.sender}: ${msg.text}`);
    }
    if(msg.type==='adminAction' && !isAdmin){
      if(msg.action==='kick'){
        alert(msg.message || 'VocÃª foi kickado.');
        leaveCall();
      }
      if(msg.action==='exit'){
        alert('Sala encerrada pelo administrador. A aba serÃ¡ fechada.');
        window.close();
      }
    }
  }

  chatInput.addEventListener('keyup', e => {
    if(e.key === 'Enter' && chatInput.value.trim()){
      const text = chatInput.value.trim();
      if(!processCommand(text)){
        Object.values(connList).forEach(c => c.conn.send({type:'chat', sender:nickname, text}));
        appendChat(`VocÃª: ${text}`);
      }
      chatInput.value = '';
    }
  });

  // Enviar com botÃ£o (opcional)
  // document.getElementById('sendChatBtn').onclick = () => {
  //   chatInput.dispatchEvent(new KeyboardEvent('keyup', {key:'Enter'}));
  // };

  // ======= Player e playlist =======
  chooseMediaBtn.onclick = () => {
    fileMenu.style.display = 'flex';
  };
  selectFileBtn.onclick = () => {
    fileMenu.style.display = 'none';
    const inputFile = document.createElement('input');
    inputFile.type = 'file';
    inputFile.accept = "video/*,audio/*";
    inputFile.onchange = e => {
      const file = e.target.files[0];
      if(file){
        const url = URL.createObjectURL(file);
        playlist.push({name:file.name, url, sender: nickname});
        updatePlaylistUI();
      }
    };
    inputFile.click();
  };
  insertLinkBtn.onclick = () => {
    fileMenu.style.display = 'none';
    const url = prompt('Cole o link do arquivo (qualquer site que permita reproduÃ§Ã£o)');
    if(url){
      const name = url.split('/').pop().split('?')[0] || url;
      playlist.push({name, url, sender: nickname});
      updatePlaylistUI();
    }
  };

  function updatePlaylistUI(){
    if(playlist.length === 0){
      playlistContent.textContent = 'Sem arquivos ainda.';
      return;
    }
    playlistContent.innerHTML = '';
    playlist.forEach((item, i) => {
      const div = document.createElement('div');
      div.className = 'playlist-item';
      div.textContent = `${item.sender}: ${item.name}`;
      div.onclick = () => playFromPlaylist(i);
      playlistContent.appendChild(div);
    });
  }

  function playFromPlaylist(index){
    if(index < 0 || index >= playlist.length) return;
    const item = playlist[index];
    mediaPlayer.src = item.url;
    mediaPlayer.play();
  }

  showPlaylistBtn.onclick = () => {
    const isMobile = window.innerWidth <= 768;
    if(isMobile){
      chatArea.style.display = 'none';
      playlistMenu.style.display = 'flex';
    } else {
      playlistMenu.style.display = playlistMenu.style.display === 'flex' ? 'none' : 'flex';
    }
  };

  function closePlaylist(){
    playlistMenu.style.display = 'none';
    if(window.innerWidth <= 768) chatArea.style.display = 'flex';
  }

  clearPlaylistBtn.onclick = () => {
    if(!isAdmin) return;
    playlist.length = 0;
    updatePlaylistUI();
  };

  toggleAutoPlay.onclick = () => {
    autoPlay = !autoPlay;
    toggleAutoPlay.textContent = `Rep. AutomÃ¡tica: ${autoPlay ? 'ON' : 'OFF'}`;
  };

  mediaPlayer.onended = () => {
    if(autoPlay && playlist.length > 0){
      const currentIndex = playlist.findIndex(item => item.url === mediaPlayer.src);
      let nextIndex = currentIndex + 1;
      if(nextIndex >= playlist.length) nextIndex = 0;
      playFromPlaylist(nextIndex);
    }
  };

  // ====== Auto ajuste da tela de cÃ³digo (menuSetup) =======
  function ajustaTelaSetup(){
    const width = window.innerWidth;
    if(width <= 768){
      menuSetup.style.width = '90%';
      menuSetup.style.margin = 'auto';
      menuSetup.style.fontSize = '1.1rem';
    } else if(width > 1600){
      menuSetup.style.width = '600px';
      menuSetup.style.margin = '2rem auto';
      menuSetup.style.fontSize = '1rem';
    } else {
      menuSetup.style.width = '400px';
      menuSetup.style.margin = '5rem auto';
      menuSetup.style.fontSize = '1rem';
    }
  }
  window.addEventListener('resize', ajustaTelaSetup);
  ajustaTelaSetup();

});
</script>
</body>
</html>
