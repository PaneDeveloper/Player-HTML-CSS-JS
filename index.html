<!DOCTYPE html><html lang="pt-BR"><head><meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Player + Voice Chat</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#121212;color:#EEE;font-family:Arial,sans-serif;display:flex;flex-direction:column;height:100vh;}
  #mainUI{flex:1;display:flex;overflow:hidden;}
  #playerArea{flex:2;background:#222;display:flex;flex-direction:column;align-items:center;padding:1rem;}
  video,audio,iframe{width:100%;max-width:800px;border-radius:6px;background:#000;}
  #controls{margin:1rem;display:flex;gap:.5rem;}
  .btn{background:#ff4500;border:none;color:#FFF;padding:.5rem 1rem;border-radius:5px;cursor:pointer;}
  #chatArea,#membersArea{flex:1;display:none;flex-direction:column;background:#1f1f1f;border-left:1px solid #333;}
  #membersArea.active,#chatArea.active{display:flex;}
  #membersList{flex:0 0 auto;padding:0.5rem;overflow-y:auto;}
  .member{display:flex;align-items:center;gap:.5rem;padding:.5rem;position:relative;}
  .member.activeSpeaker .avatar{border:2px solid #00f;border-radius:50%}
  .avatar{width:32px;height:32px;border-radius:50%;background:#555;}
  .member .actions{position:absolute;right:5px;top:5px;display:none;}
  .member.admin .actions{display:flex;gap:5px;}
  #chatLog{flex:1;overflow-y:auto;padding:0.5rem;}
  #chatInputArea{padding:0.5rem;display:flex;gap:0.5rem;}
  #chatInput{flex:1;padding:.5rem;border-radius:4px;border:none;background:#222;color:#EEE;}
  #sendChatBtn{display:none;}
  #menuSetup,#inCallUI{padding:1rem;}
  #menuSetup input{margin:0 .5rem;}
</style>
</head><body>

<!-- Setup -->
<div id="menuSetup">
  <input id="roomCode" placeholder="4 dÃ­gitos MX09"/>
  <button id="createRoom" class="btn">Criar Sala</button>
  <button id="joinRoom" class="btn">Entrar na Sala</button>
  <div id="activeRooms"></div>
</div>

<!-- Main -->
<div id="mainUI">
  <div id="playerArea">
    <video id="mediaPlayer" controls></video>
    <div id="controls">
      <button id="stopBtn" class="btn">Parar</button>
      <!-- PiP, playlist etc jÃ¡ integrados -->
    </div>
  </div>

  <div id="membersArea">
    <div id="membersList"></div>
  </div>

  <div id="chatArea">
    <div id="chatLog"></div>
    <div id="chatInputArea">
      <input id="chatInput" placeholder="Digite sua mensagem"/>
      <button id="sendChatBtn" class="btn">Enviar</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script>
(async()=>{
  const roomSetup = document.getElementById('menuSetup');
  const mainUI = document.getElementById('mainUI');
  const membersArea = document.getElementById('membersArea');
  const chatArea = document.getElementById('chatArea');
  const roomCodeInput = document.getElementById('roomCode');
  const createBtn = document.getElementById('createRoom');
  const joinBtn = document.getElementById('joinRoom');
  const membersList = document.getElementById('membersList');
  const chatLog = document.getElementById('chatLog');
  const chatInput = document.getElementById('chatInput');
  const sendChatBtn = document.getElementById('sendChatBtn');

  let peer, connList = {}, mediaStream, isAdmin=false;
  let roomID=null, userCount=0;

  function genCode(){return Math.random().toString(36).slice(2,6).toUpperCase();}

  function addMember(id, name, img){
    if(membersList.querySelector(`[data-id="${id}"]`)) return;
    const div=document.createElement('div');
    div.className='member'+(isAdmin?' admin':'');
    div.dataset.id=id;
    div.innerHTML=\`
      <div class="avatar"></div>
      <span>\${name}</span>
      <div class="actions">
        <button data-action="mute">ðŸ”‡</button>
        <button data-action="kick">ðŸš«</button>
      </div>\`;
    membersList.append(div);
    div.querySelectorAll('.actions button').forEach(btn=>{
      btn.onclick=()=>{
        connList[id].conn.send({type:'adminAction',action:btn.dataset.action,target:id});
      };
    });
  }

  function appendChat(msg){ 
    const d=document.createElement('div');
    d.textContent=msg;
    chatLog.append(d);
    chatLog.scrollTop=chatLog.scrollHeight;
  }

  async function startMedia(){
    mediaStream = await navigator.mediaDevices.getUserMedia({audio:{noiseSuppression:true}});
  }

  function enterCall(){
    roomSetup.style.display='none';
    mainUI.style.display='flex';
    membersArea.classList.add('active');
    chatArea.classList.add('active');
  }

  function leaveCall(){
    peer.destroy();
    Object.values(connList).forEach(c=>c.conn.close());
    connList={}; membersList.innerHTML='';
    chatLog.innerHTML=''; mediaStream.getTracks().forEach(t=>t.stop());
    location.reload();
  }

  createBtn.onclick=async()=>{
    roomID=genCode();
    isAdmin=true;
    peer = new Peer(roomID);
    peer.on('open',id=>{enterCall(); appendChat('Sala criada: '+id);});
    peer.on('call', call=>{
      call.answer(mediaStream);
      call.on('stream', stream=>{
        // play audio track
      });
    });
    peer.on('connection', c=>{
      c.on('open',()=>{
        userCount++;
        connList[c.peer]={conn:c};
        addMember(c.peer,'UsuÃ¡rio '+userCount);
        c.on('data',msg=>handleData(c.peer,msg));
      });
    });
    await startMedia();
  };

  joinBtn.onclick=async()=>{
    roomID=roomCodeInput.value.trim();
    peer=new Peer();
    peer.on('open',async id=>{
      await startMedia();
      const conn=peer.connect(roomID);
      conn.on('open',()=>{
        conn.send({type:'joinRequest',name:'UsuÃ¡rio'});
      });
      conn.on('data',msg=>handleData(roomID,msg));
      connList[roomID]={conn,initiator:true};
    });
  };

  function handleData(peerId,msg){
    if(msg.type==='joinRequest' && isAdmin){
      const ok = confirm(\`\${msg.name} quer entrar. Aceitar?\`);
      connList[peerId].conn.send({type:'joinResponse',accepted:ok,assignedID:peerId});
      if(ok){
        addMember(peerId,msg.name);
        const call=peer.call(peerId, mediaStream);
        connList[peerId].call=call;
        call.on('stream', stream=>{});
      }
    }
    if(msg.type==='joinResponse'){
      if(msg.accepted){enterCall(); appendChat('VocÃª entrou na sala!');}
      else alert('Entrada negada pelo administrador.');
    }
    if(msg.type==='chat'){
      appendChat(msg.sender+': '+msg.text);
    }
    if(msg.type==='adminAction' && !isAdmin){
      if(msg.action==='kick' || msg.action==='ban'){
        alert('VocÃª foi '+msg.action);
        leaveCall();
      }
    }
  }

  chatInput.addEventListener('keyup',e=>{
    if(e.key==='Enter' && chatInput.value.trim()){
      const text=chatInput.value.trim();
      Object.values(connList).forEach(c=>c.conn.send({type:'chat',sender:peer.id,text}));
      appendChat('VocÃª: '+text);
      chatInput.value='';
    }
  });

})();
</script>
</body></html>