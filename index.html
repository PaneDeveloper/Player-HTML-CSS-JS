<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Chat + Player</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#121212;color:#EEE;font-family:Arial,sans-serif;display:flex;flex-direction:column;height:100vh;}
  
  #mainUI {
    max-width: 1200px;
    margin: 0 auto;
    box-sizing: border-box;
    display: none;
    flex-direction: row;
    flex: 1;
  }

  @media (min-width: 1600px) {
    #mainUI {
      max-width: 900px;
      margin: 2rem auto;
      border: 1px solid #444;
      border-radius: 10px;
      box-shadow: 0 0 20px #0008;
    }
  }

  @media (max-width: 768px) {
    #mainUI {
      display: none !important; /* esconder inicialmente */
      flex-direction: column !important;
      width: 100% !important;
      height: 100vh !important;
      margin: 0 !important;
      padding: 0.5rem !important;
    }
    #playerArea {
      flex: none !important;
      width: 100% !important;
      max-width: 100% !important;
      height: auto !important;
    }
    #chatArea {
      flex: none !important;
      width: 100% !important;
      height: 150px !important;
      border-left: none !important;
      border-top: 1px solid #333 !important;
      margin-top: 0.5rem !important;
      display: flex !important;
    }
  }

  #playerArea{flex:2;background:#222;display:flex;flex-direction:column;align-items:center;padding:1rem;position:relative;}
  video{width:100%;max-width:800px;border-radius:6px;background:#000;}
  #controls{margin:1rem;display:flex;gap:.5rem;flex-wrap:wrap;}
  .btn{background:#ff4500;border:none;color:#FFF;padding:.5rem 1rem;border-radius:5px;cursor:pointer;}
  #chatArea{flex:1;display:flex;flex-direction:column;background:#1f1f1f;border-left:1px solid #333;}
  #chatLog{flex:1;overflow-y:auto;padding:0.5rem;}
  #chatInputArea{padding:0.5rem;display:flex;gap:0.5rem;}
  #chatInput{flex:1;padding:.5rem;border-radius:4px;border:none;background:#222;color:#EEE;}
  #menuSetup,#namePrompt{padding:1rem;display:flex;flex-direction:column;gap:.5rem;align-items:center;}
  #sendChatBtn{display:none;}
  #fileMenu, #playlistMenu {
    position: absolute;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    padding: 1rem;
    border-radius: 8px;
    display: none;
    flex-direction: column;
    gap: 0.5rem;
    z-index: 10;
    min-width: 300px;
  }
  #fileMenu button, #playlistMenu button {
    background: #444;
    color: white;
    padding: 0.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  .closeBtn {
    position: absolute;
    top: 0.2rem;
    right: 0.5rem;
    background: transparent;
    border: none;
    color: #f00;
    font-size: 1.2rem;
    cursor: pointer;
  }
  .playlist-controls {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  .playlist-item {
    cursor: pointer;
    padding: 0.3rem;
    border-radius: 4px;
  }
  .playlist-item:hover {
    background: #555;
  }
  .system-msg {
    color: #0ff;
    font-style: italic;
  }
</style>
</head>
<body>
  <div id="menuSetup">
    <input id="roomCode" placeholder="CÃ³digo da sala (ex: MX09)"/>
    <button id="createRoom" class="btn">Criar Sala</button>
    <button id="joinRoom" class="btn">Entrar na Sala</button>
  </div>

  <div id="namePrompt" style="display:none;">
    <input id="nickname" placeholder="Seu nome de usuÃ¡rio"/>
    <button id="enterRoom" class="btn">Entrar</button>
  </div>

  <div id="mainUI">
    <div id="playerArea">
      <video id="mediaPlayer" controls></video>
      <div id="controls">
        <button id="chooseMediaBtn" class="btn">Escolher Arquivo/Link</button>
        <button id="showPlaylistBtn" class="btn">ðŸ“ƒ Playlist</button>
      </div>

      <div id="fileMenu">
        <button class="closeBtn" onclick="document.getElementById('fileMenu').style.display='none'">âœ–</button>
        <button id="selectFileBtn">Escolher do dispositivo</button>
        <button id="insertLinkBtn">Inserir link</button>
      </div>

      <div id="playlistMenu">
        <button class="closeBtn" onclick="document.getElementById('playlistMenu').style.display='none'">âœ–</button>
        <div class="playlist-controls">
          <button id="toggleAutoPlay" class="btn">Rep. AutomÃ¡tica: OFF</button>
          <button id="clearPlaylistBtn" class="btn" style="display:none;">Limpar Fila</button>
        </div>
        <div id="playlistContent">Sem arquivos ainda.</div>
      </div>
    </div>
    <div id="chatArea">
      <div id="chatLog"></div>
      <div id="chatInputArea">
        <input id="chatInput" placeholder="Digite sua mensagem" autocomplete="off"/>
        <button id="sendChatBtn" class="btn">Enviar</button>
      </div>
    </div>
  </div>

<script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
<script>
let connList = {};
let peer;
let myId = '';
let isAdmin = false;
let roomId = '';
let nickname = '';

const menuSetup = document.getElementById('menuSetup');
const namePrompt = document.getElementById('namePrompt');
const mainUI = document.getElementById('mainUI');
const nicknameInput = document.getElementById('nickname');
const enterRoomBtn = document.getElementById('enterRoom');
const roomCodeInput = document.getElementById('roomCode');
const chatLog = document.getElementById('chatLog');
const chatInput = document.getElementById('chatInput');

const mediaPlayer = document.getElementById('mediaPlayer');

function appendChat(msg, isSystem = false) {
  const div = document.createElement('div');
  div.textContent = msg;
  if (isSystem) div.classList.add('system-msg');
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

// Broadcast para todos os conectados (exceto sender opcional)
function broadcast(msg, exceptPeerId = null) {
  Object.entries(connList).forEach(([peerId, connObj]) => {
    if (peerId !== exceptPeerId) {
      connObj.conn.send(msg);
    }
  });
}

// Criar Peer
function createPeer(id) {
  peer = new Peer(id);

  peer.on('open', id => {
    myId = id;
    isAdmin = (roomAction === 'create');
    appendChat(`Sistema: Sala criada com cÃ³digo ${id}`, true);
    enterRoomUI();
  });

  peer.on('connection', conn => {
    const remoteId = conn.peer;
    connList[remoteId] = {conn};
    conn.on('data', data => handleData(remoteId, data));
    conn.on('open', () => {
      console.log('ConexÃ£o aberta com', remoteId);
      if (isAdmin) {
        conn.send({type:'joinResponse', accepted:true, assignedID: remoteId});
        broadcast({type:'system', text:`UsuÃ¡rio ${remoteId} entrou na sala`});
        appendChat(`Sistema: UsuÃ¡rio ${remoteId} entrou na sala`, true);
      }
    });
    conn.on('close', () => {
      delete connList[remoteId];
      broadcast({type:'system', text:`UsuÃ¡rio ${remoteId} saiu da sala`});
      appendChat(`Sistema: UsuÃ¡rio ${remoteId} saiu da sala`, true);
    });
  });

  peer.on('error', err => {
    console.error('Peer error:', err);
    alert('Erro no Peer: ' + err);
  });
}

function joinRoom(id) {
  peer = new Peer();

  peer.on('open', myIdLocal => {
    myId = myIdLocal;
    const conn = peer.connect(id);
    connList[id] = {conn, initiator:true};

    conn.on('open', () => {
      conn.send({type:'joinRequest', name: nickname, from: myId});
    });

    conn.on('data', data => handleData(id, data));

    conn.on('close', () => {
      appendChat('VocÃª saiu da sala.', true);
      resetUI();
    });
  });
}

function handleData(peerId, msg) {
  if (msg.type === 'joinRequest' && isAdmin) {
    const accept = true;
    connList[peerId].conn.send({type:'joinResponse', accepted: accept, assignedID: peerId, name: msg.name});
    if (accept) {
      broadcast({type:'system', text:`UsuÃ¡rio ${msg.name} entrou na sala`});
      appendChat(`Sistema: UsuÃ¡rio ${msg.name} entrou na sala`, true);
    }
  } else if (msg.type === 'joinResponse' && !isAdmin) {
    if (msg.accepted) {
      enterRoomUI();
      appendChat('Sistema: VocÃª entrou na sala!', true);
    } else {
      alert('Entrada negada pelo administrador.');
      resetUI();
    }
  } else if (msg.type === 'chat') {
    appendChat(`${msg.sender}: ${msg.text}`);
  } else if (msg.type === 'system') {
    appendChat(`Sistema: ${msg.text}`, true);
  } else if (msg.type === 'mediaChange') {
    mediaPlayer.src = msg.url;
    mediaPlayer.play();
  }
}

function enterRoomUI() {
  menuSetup.style.display = 'none';
  namePrompt.style.display = 'none';
  mainUI.style.display = 'flex';

  // Importante: liberar controles do player e chat
  mediaPlayer.controls = true;
  mediaPlayer.style.pointerEvents = 'auto';
  chatInput.disabled = false;
  chatInput.style.pointerEvents = 'auto';
}

function resetUI() {
  mainUI.style.display = 'none';
  menuSetup.style.display = 'flex';
  namePrompt.style.display = 'none';
  nicknameInput.value = '';
  roomCodeInput.value = '';
  chatLog.innerHTML = '';
  mediaPlayer.pause();
  mediaPlayer.src = '';
  Object.values(connList).forEach(c => c.conn.close());
  connList = {};
  peer && peer.destroy();
  peer = null;
  isAdmin = false;
  roomId = '';
  nickname = '';
}

// BotÃµes tela inicial
const createRoomBtn = document.getElementById('createRoom');
const joinRoomBtn = document.getElementById('joinRoom');
const enterRoomBtn = document.getElementById('enterRoom');

let roomAction = '';

createRoomBtn.onclick = () => {
  roomAction = 'create';
  menuSetup.style.display = 'none';
  namePrompt.style.display = 'flex';
  nicknameInput.focus();
};

joinRoomBtn.onclick = () => {
  roomAction = 'join';
  menuSetup.style.display = 'none';
  namePrompt.style.display = 'flex';
  nicknameInput.focus();
};

enterRoomBtn.onclick = () => {
  const name = nicknameInput.value.trim();
  if (!name) {
    alert('Digite um nome!');
    return;
  }
  nickname = name;
  if (roomAction === 'create') {
    roomId = roomCodeInput.value.trim() || nickname + '-' + Math.floor(Math.random() * 1000);
    createPeer(roomId);
  } else if (roomAction === 'join') {
    roomId = roomCodeInput.value.trim();
    if (!roomId) {
      alert('Digite o cÃ³digo da sala!');
      return;
    }
    joinRoom(roomId);
  }
};

// Enter no campo de nickname para entrar direto
nicknameInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    enterRoomBtn.click();
  }
});

// Chat enviar mensagem ao apertar Enter
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && chatInput.value.trim()) {
    e.preventDefault();
    sendChat();
  }
});

function sendChat() {
  const text = chatInput.value.trim();
  if (!text) return;
  broadcast({type:'chat', sender: nickname, text});
  appendChat(`VocÃª: ${text}`);
  chatInput.value = '';
}
</script>
</body>
</html>
