<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Chat + Player Completo</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#121212;color:#EEE;font-family:Arial,sans-serif;display:flex;flex-direction:column;height:100vh;}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}
    #menuSetup,#namePrompt,#waitingApproval{padding:1rem;display:flex;flex-direction:column;gap:.5rem;align-items:center;text-align:center;}
    #mainUI{display:none;flex:1;flex-direction:row;max-width:1200px;margin:0 auto;position:relative;}
    @media(min-width:1600px){#mainUI{max-width:900px;margin:2rem auto;border:1px solid #444;border-radius:10px;box-shadow:0 0 20px #0008;}}
    @media(max-width:768px){
      #mainUI{flex-direction:column!important;width:100%!important;height:100vh!important;padding:.5rem!important;}
      #playerArea,#chatArea{width:100%!important;}
      #chatArea{height:150px!important;border-left:none!important;border-top:1px solid #333!important;margin-top:.5rem!important;}
    }
    #playerArea{flex:2;background:#222;display:flex;flex-direction:column;align-items:center;padding:1rem;position:relative;}
    video{width:100%;max-width:800px;border-radius:6px;background:#000;position:relative;z-index:1;}
    #controls{margin:1rem;display:flex;gap:.5rem;flex-wrap:wrap;position:relative;z-index:1;}
    .btn{background:#ff4500;border:none;color:#FFF;padding:.5rem 1rem;border-radius:5px;cursor:pointer;z-index:1;}
    #chatArea{flex:1;display:flex;flex-direction:column;background:#1f1f1f;border-left:1px solid #333;position:relative;}
    #chatLog{flex:1;overflow-y:auto;padding:.5rem;}
    #chatInputArea{padding:.5rem;display:flex;gap:.5rem;}
    #chatInput{flex:1;padding:.5rem;border-radius:4px;border:none;background:#222;color:#EEE;}
    #fileMenuModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);display:none;justify-content:center;align-items:center;z-index:9999;}
    #fileMenuContent{background:#333;padding:1.5rem;border-radius:8px;min-width:320px;display:flex;flex-direction:column;gap:.75rem;}
    #fileMenuContent button{background:#444;color:#fff;padding:.75rem;border:none;border-radius:5px;cursor:pointer;font-size:1rem;}
    #participantListModal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);display:none;justify-content:center;align-items:center;z-index:9998;}
    #participantListContent{background:#333;padding:1rem 1.5rem;border-radius:8px;max-width:320px;width:100%;max-height:400px;overflow-y:auto;position:relative;}
    #participantListContent h3{color:#eee;text-align:center;margin-bottom:1rem;}
    #participantListContent .participantItem{display:flex;align-items:center;justify-content:space-between;padding:.3rem 0;border-bottom:1px solid #444;}
    #participantListContent .participantItem:hover{background:#333;}
    #participantListContent .participantName{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    #participantListContent .admin-controls{display:flex;gap:.3rem;}
    #participantListContent .admin-controls button{background:#444;border:none;color:#EEE;padding:.2rem .5rem;border-radius:4px;cursor:pointer;font-size:.8rem;}
    #participantListContent .admin-controls .danger{background:#a00;}
  </style>
</head>
<body>
  <!-- Tela inicial -->
  <div id="menuSetup">
    <label for="roomCode" class="sr-only">C칩digo da sala</label>
    <input id="roomCode" placeholder="C칩digo da sala (ex: A91J)" maxlength="4" style="text-transform:uppercase"/>
    <button id="createRoom" class="btn" aria-label="Criar sala">Criar Sala</button>
    <button id="joinRoom" class="btn" aria-label="Entrar na sala">Entrar na Sala</button>
  </div>

  <!-- Prompt de nome -->
  <div id="namePrompt" style="display:none;">
    <label for="nickname" class="sr-only">Nome de usu치rio</label>
    <input id="nickname" placeholder="Seu nome de usu치rio" aria-label="Seu nome de usu치rio"/>
    <button id="enterRoom" class="btn" aria-label="Entrar na sala ap칩s digitar nome">Entrar</button>
  </div>

  <!-- Espera aprova칞칚o -->
  <div id="waitingApproval" style="display:none;">
    <img src="https://media.tenor.com/On7kvXhzml4AAAAj/loading-gif.gif" alt="Carregando" width="64" height="64"/>
    <p aria-live="assertive">Esperando o Administrador aceitar sua solicita칞칚o...</p>
  </div>

  <!-- Main UI -->
  <div id="mainUI">
    <div id="playerArea">
      <video id="mediaPlayer" controls autoplay aria-label="Reprodutor de m칤dia"></video>
      <div id="controls">
        <button id="chooseMediaBtn" class="btn" aria-label="Escolher arquivo, link ou tela para reprodu칞칚o">Escolher Arquivo/Link/Tela</button>
        <button id="showPlaylistBtn" class="btn" aria-label="Mostrar playlist em nova janela ou guia">游늮 Playlist</button>
        <button id="showParticipantsBtn" class="btn" aria-label="Mostrar participantes da sala">游논 Participantes</button>
      </div>
    </div>
    <div id="chatArea">
      <div id="chatLog" aria-live="polite" aria-label="Registro de chat"></div>
      <div id="chatInputArea">
        <label for="chatInput" class="sr-only">Mensagem</label>
        <input id="chatInput" placeholder="Digite sua mensagem" autocomplete="off" aria-label="Campo para digitar mensagem"/>
        <button id="sendChatBtn" class="btn" aria-label="Enviar mensagem de chat">Enviar</button>
      </div>
    </div>
  </div>

  <!-- Modal M칤dia -->
  <div id="fileMenuModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="fileMenuTitle">
    <div id="fileMenuContent">
      <button id="selectFileBtn" aria-label="Selecionar arquivo do dispositivo">Escolher do dispositivo</button>
      <button id="insertLinkBtn" aria-label="Inserir link de m칤dia">Inserir link</button>
      <button id="shareScreenBtn" aria-label="Transmitir tela do dispositivo">Transmitir Tela</button>
    </div>
  </div>

  <!-- Modal Participantes -->
  <div id="participantListModal" tabindex="-1" role="dialog" aria-modal="true" aria-labelledby="participantListTitle">
    <div id="participantListContent">
      <h3 id="participantListTitle">Participantes da Sala</h3>
      <div id="participantList"></div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script>
    let peer, connList = {}, isAdmin = false, roomID = '', myName = '', currentMedia = null, pendingRequests = {};

    // Elementos
    const menuSetup = document.getElementById('menuSetup');
    const namePrompt = document.getElementById('namePrompt');
    const waitingApproval = document.getElementById('waitingApproval');
    const mainUI = document.getElementById('mainUI');
    const mediaPlayer = document.getElementById('mediaPlayer');
    const chooseMediaBtn = document.getElementById('chooseMediaBtn');
    const showPlaylistBtn = document.getElementById('showPlaylistBtn');
    const showParticipantsBtn = document.getElementById('showParticipantsBtn');
    const participantList = document.getElementById('participantList');
    const participantListModal = document.getElementById('participantListModal');
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    const fileMenuModal = document.getElementById('fileMenuModal');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const insertLinkBtn = document.getElementById('insertLinkBtn');
    const shareScreenBtn = document.getElementById('shareScreenBtn');

    const enterRoomBtn = document.getElementById('enterRoom');
    const nicknameInput = document.getElementById('nickname');

    // Append chat
    function appendChat(msg){ 
      const d=document.createElement('div'); 
      d.textContent=msg; 
      chatLog.appendChild(d); 
      chatLog.scrollTop=chatLog.scrollHeight; 
    }

    // Send to all
    function sendToAll(data){ 
      Object.values(connList).forEach(c=>c.conn.send(data)); 
    }

    // Setup calls
    function setupCallHandlers(){ 
      peer.on('call', call=>{
        call.answer(); 
        call.on('stream',stream=>{
          mediaPlayer.srcObject=stream; 
          mediaPlayer.play(); 
        }); 
      }); 
    }

    // Create room
    function createRoom(code){
      peer=new Peer(code); isAdmin=true;
      peer.on('open',()=>appendChat('[Sistema] Sala criada: '+code));
      peer.on('connection',conn=>{
        conn.on('data',data=>{
          if(data.type==='media'){ currentMedia=data; applyMedia(data); }
          if(data.type==='chat') appendChat(data.name+': '+data.msg);
          if(data.type==='joinRequest'){ handleJoinRequest(conn,data); }
          if(data.type==='punish') handlePunish(data);
        });
        connList[conn.peer]={conn};
        updateParticipantList();
      });
      setupCallHandlers();
    }

    // Join room
    function joinRoom(code,name){
      peer=new Peer(); isAdmin=false; myName=name;
      peer.on('open',()=>{
        const conn=peer.connect(code);
        conn.on('open',()=>{
          conn.send({type:'joinRequest',name});
          waitingApproval.style.display='flex';
        });
        conn.on('data',data=>{
          if(data.type==='joinAccept'){
            waitingApproval.style.display='none'; 
            enterMainUI();
          }
          if(data.type==='joinDeny'){
            alert('Entrada negada');
            location.reload();
          }
          if(data.type==='media') applyMedia(data);
          if(data.type==='chat') appendChat(data.name+': '+data.msg);
          if(data.type==='punish') handlePunish(data);
        });
        connList[code]={conn};
      });
      setupCallHandlers();
    }

    // Apply media
    function applyMedia(data){
      mediaPlayer.srcObject=null;
      mediaPlayer.src=data.url;
      mediaPlayer.onloadedmetadata=()=>{
        mediaPlayer.currentTime=data.time||0;
        data.paused?mediaPlayer.pause():mediaPlayer.play();
      };
    }

    // Handle join requests (admin)
    function handleJoinRequest(conn,data){
      pendingRequests[conn.peer]={conn,name:data.name};
      appendChat('[Sistema] Pedido de ' + data.name);
      // show request UI (simplified)
      if(confirm(data.name + ' quer entrar. Aceitar?')){
        conn.send({type:'joinAccept'});
        connList[conn.peer]={conn,name:data.name};
        updateParticipantList();
      } else {
        conn.send({type:'joinDeny'});
      }
    }

    // Handle punish
    function handlePunish(data){
      if(data.action==='silence') applySilence(data);
      else if(data.action!=='chat') alert('Voc칡 foi ' + data.action);
    }

    function applySilence(data){
      chatInput.disabled=true;
      const end=Date.now()+parseTime(data.time);
      const iv=setInterval(()=>{
        const rem=end-Date.now();
        if(rem<=0){
          clearInterval(iv);
          chatInput.disabled=false;
          chatInput.placeholder='Digite sua mensagem';
          return;
        }
        chatInput.placeholder='Silenciado, resto ' + Math.ceil(rem/60000) + 'min';
      },1000);
    }

    function parseTime(val){
      if(val.endsWith('m')) return parseInt(val)*60000;
      if(val.endsWith('h')) return parseInt(val)*3600000;
      return Infinity;
    }

    // Update participants UI
    function updateParticipantList(){
      participantList.innerHTML='';
      Object.entries(connList).forEach(([peerId,u])=>{
        const div=document.createElement('div');
        div.className='participantItem';
        div.title=u.ua||'';
        const nameSpan=document.createElement('span');
        nameSpan.className='participantName';
        nameSpan.textContent=u.name||peerId;
        div.appendChild(nameSpan);
        if(isAdmin){
          const ac=document.createElement('div');
          ac.className='admin-controls';
          ['silence','kick','ban'].forEach(act=>{
            const b=document.createElement('button');
            b.textContent=act;
            if(act!=='silence') b.className='danger';
            b.onclick=()=>openPunish(peerId,act,u.name);
            ac.appendChild(b);
          });
          div.appendChild(ac);
        }
        participantList.appendChild(div);
      });
    }

    function openPunish(peerId,action,name){
      alert('Punir ' + name + ' com a칞칚o ' + action + '. (Fun칞칚o de puni칞칚o aqui)');
    }

    // Button events
    document.getElementById('createRoom').onclick=()=>{
      roomID=Math.random().toString(36).substr(2,4).toUpperCase();
      menuSetup.style.display='none';
      namePrompt.style.display='flex';
      enterRoomBtn.onclick=()=>{
        myName=nicknameInput.value.trim()||'Usu치rio';
        if(!myName) return alert('Digite um nome v치lido');
        namePrompt.style.display='none';
        createRoom(roomID);
        enterMainUI();
      };
    };
    document.getElementById('joinRoom').onclick=()=>{
      const code=document.getElementById('roomCode').value.trim().toUpperCase();
      if(!code) return alert('Digite o c칩digo da sala');
      menuSetup.style.display='none';
      namePrompt.style.display='flex';
      enterRoomBtn.onclick=()=>{
        const nm=nicknameInput.value.trim()||'Usu치rio';
        if(!nm) return alert('Digite um nome v치lido');
        namePrompt.style.display='none';
        joinRoom(code,nm);
      };
    };

    function enterMainUI(){
      mainUI.style.display='flex';
      updateParticipantList();
    }

    // Show playlist and participants
    showParticipantsBtn.onclick = () => {
      participantListModal.style.display = 'flex';
    };
    participantListModal.onclick = e => {
      if (e.target === participantListModal) participantListModal.style.display = 'none';
    };

    chooseMediaBtn.onclick = () => {
      fileMenuModal.style.display = 'flex';
    };
    fileMenuModal.onclick = e => {
      if (e.target === fileMenuModal) fileMenuModal.style.display = 'none';
    };

    selectFileBtn.onclick = () => {
      fileMenuModal.style.display = 'none';
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'video/*,audio/*';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        currentMedia = { type: 'media', url, paused: false, time: 0 };
        applyMedia(currentMedia);
        if (isAdmin) sendToAll(currentMedia);
      };
      input.click();
    };

    insertLinkBtn.onclick = () => {
      fileMenuModal.style.display = 'none';
      const url = prompt('Digite a URL do arquivo de m칤dia:');
      if (url) {
        currentMedia = { type: 'media', url, paused: false, time: 0 };
        applyMedia(currentMedia);
        if (isAdmin) sendToAll(currentMedia);
      }
    };

    shareScreenBtn.onclick = async () => {
      fileMenuModal.style.display = 'none';
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        mediaPlayer.srcObject = stream;
        mediaPlayer.play();
        currentMedia = { type: 'media', url: '', paused: false, time: 0, isScreen: true };
        if (isAdmin) sendToAll(currentMedia);
      } catch (e) {
        alert('Falha ao compartilhar a tela: ' + e.message);
      }
    };

    // Chat send
    sendChatBtn.onclick = () => {
      const msg = chatInput.value.trim();
      if (!msg) return;
      appendChat(myName + ': ' + msg);
      if (isAdmin) sendToAll({ type: 'chat', name: myName, msg });
      else if (connList[roomID]) connList[roomID].conn.send({ type: 'chat', name: myName, msg });
      chatInput.value = '';
    };

    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendChatBtn.onclick();
    });

    // Media player events for syncing
    mediaPlayer.onpause = () => {
      if (!isAdmin) return;
      currentMedia.paused = true;
      currentMedia.time = mediaPlayer.currentTime;
      sendToAll(currentMedia);
    };

    mediaPlayer.onplay = () => {
      if (!isAdmin) return;
      currentMedia.paused = false;
      currentMedia.time = mediaPlayer.currentTime;
      sendToAll(currentMedia);
    };

  </script>
</body>
</html>

EM DESENVOLVIMENTO, Vers칚o beta
